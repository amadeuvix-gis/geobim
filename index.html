<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Idaho Falls</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/dark/main.css">
<script src="https://js.arcgis.com/4.34/"></script>

<style>
html, body, #viewDiv {
  height: 100%; margin: 0; padding: 0;
  font-family: "Segoe UI", Arial, sans-serif;
}

/* Header */
#header {
  position: absolute; top: 0; left: 0; right: 0;
  height: 40px; background: #111; color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2em; z-index: 120; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* Floating Buttons */
.floating-btn {
  position: absolute; width: 50px; height: 50px;
  border-radius: 6px; display: flex; align-items: center; justify-content: center;
  background: #333; color: #fff; cursor: pointer; font-size: 1.4em;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3); transition: all 0.2s ease-in-out;
  z-index: 120;
}
.floating-btn:hover { background: #0079c1; transform: scale(1.1); }

#btnBookmarks { top: 60px; right: 10px; }
#btnLayers { top: 120px; right: 10px; }
#btnLegend { top: 180px; right: 10px; }
#btnDaylight { top: 240px; right: 10px; }
#btnMeasurement { top: 300px; right: 10px; }
#btnElevation { top: 360px; right: 10px; }

/* Side Panels */
.side-panel {
  width: 360px; height: 85%; background: #222222ee; 
  position: absolute; top: 50px; right: -380px;
  border-radius: 8px; box-shadow: -2px 0 8px rgba(0,0,0,0.7);
  overflow-y: auto; transition: right 0.4s ease-in-out; padding: 10px; z-index: 110;
}
.side-panel.open { right: 70px; }

.panel-header {
  display: flex; justify-content: space-between; align-items: center;
  font-weight: bold; margin-bottom: 8px;
}
.panel-header button {
  background: transparent; border: none; color: #fff; font-size: 1.2em; cursor: pointer;
}

/* Bookmarks */
.bookmark-item {
  display: flex; align-items: center; margin-bottom: 8px;
  cursor: pointer; background: #333; padding: 5px; border-radius: 5px;
}
.bookmark-item:hover { background: #0079c1; }
.bookmark-item img { width: 60px; height: 40px; object-fit: cover; margin-right: 8px; border-radius: 3px; }
.bookmark-item span { color: #fff; font-size: 0.95em; }
</style>
</head>
<body>
<div id="viewDiv"></div>
<div id="header">Idaho Falls - Proposed</div>

<!-- Floating Buttons -->
<div id="btnBookmarks" class="floating-btn" title="Bookmarks">üîñ</div>
<div id="btnLayers" class="floating-btn" title="Layers">üìÇ</div>
<div id="btnLegend" class="floating-btn" title="Legend">üìã</div>
<div id="btnDaylight" class="floating-btn" title="Daylight">üí°</div>
<div id="btnMeasurement" class="floating-btn" title="3D Measurement">üìè</div>
<div id="btnElevation" class="floating-btn" title="Elevation Profile">‚õ∞Ô∏è</div>

<!-- Panels -->
<div id="bookmarksPanel" class="side-panel"><div class="panel-header">Bookmarks <button>√ó</button></div></div>
<div id="layersPanel" class="side-panel"><div class="panel-header">Layers <button>√ó</button></div></div>
<div id="legendPanel" class="side-panel"><div class="panel-header">Legend <button>√ó</button></div></div>
<div id="daylightPanel" class="side-panel"><div class="panel-header">Daylight <button>√ó</button></div></div>
<div id="measurementPanel" class="side-panel"><div class="panel-header">3D Measurement <button>√ó</button></div></div>
<div id="elevationPanel" class="side-panel"><div class="panel-header">Elevation Profile <button>√ó</button></div></div>

<script>
require([
  "esri/WebScene","esri/views/SceneView","esri/widgets/LayerList","esri/widgets/Legend",
  "esri/widgets/Daylight","esri/widgets/DirectLineMeasurement3D","esri/widgets/ElevationProfile",
  "esri/widgets/Bookmarks","esri/Graphic","esri/geometry/Polyline"
], function(WebScene, SceneView, LayerList, Legend, Daylight, DirectLineMeasurement3D, ElevationProfile, Bookmarks, Graphic, Polyline){

  const webscene = new WebScene({ portalItem:{id:"d841bada1a9a4a389a083fbc8102068d"} });
  const view = new SceneView({ container:"viewDiv", map:webscene, qualityProfile:"high", environment:{lighting:{directShadowsEnabled:true}} });

  // Widgets
  const layerListWidget = new LayerList({ view });
  const legendWidget = new Legend({ view });
  const daylightWidget = new Daylight({ view });
  const measurementWidget = new DirectLineMeasurement3D({ view });
  const elevationWidget = new ElevationProfile({ view, profiles:[{ type:"ground" }] });
  const bookmarksWidget = new Bookmarks({ view });

  const panels = {
    btnLayers: { panelId:"layersPanel", widget: layerListWidget },
    btnLegend: { panelId:"legendPanel", widget: legendWidget },
    btnDaylight: { panelId:"daylightPanel", widget: daylightWidget },
    btnMeasurement: { panelId:"measurementPanel", widget: measurementWidget },
    btnElevation: { panelId:"elevationPanel", widget: elevationWidget }
  };

  Object.keys(panels).forEach(btnId => {
    const btn = document.getElementById(btnId);
    const panel = document.getElementById(panels[btnId].panelId);
    const widget = panels[btnId].widget;
    widget.container = panel;
    // Close button
    panel.querySelector("button").onclick = ()=>panel.classList.remove("open");
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".side-panel").forEach(p=>{if(p!==panel)p.classList.remove("open");});
      panel.classList.toggle("open");
      if(btnId==="btnElevation") initElevationDraw();
    });
  });

  // Bookmarks
  const bookmarksPanel = document.getElementById("bookmarksPanel");
  bookmarksPanel.querySelector("button").onclick = ()=>bookmarksPanel.classList.remove("open");
  document.getElementById("btnBookmarks").addEventListener("click", ()=>{
    document.querySelectorAll(".side-panel").forEach(p=>{if(p!==bookmarksPanel)p.classList.remove("open");});
    bookmarksPanel.classList.toggle("open");
  });

  webscene.when(()=>{
    if(webscene.presentation?.slides?.length>0){
      webscene.presentation.slides.forEach(slide=>{
        const div = document.createElement("div"); div.className="bookmark-item";
        const img = document.createElement("img"); img.src=slide.thumbnail.url;
        const span = document.createElement("span"); span.textContent=slide.title.text||"Slide";
        div.appendChild(img); div.appendChild(span);
        div.onclick=()=>{ slide.applyTo(view); bookmarksPanel.classList.remove("open"); };
        bookmarksPanel.appendChild(div);
      });
    }
  });

  // Elevation Profile Draw
  function initElevationDraw(){
    view.graphics.removeAll();
    let points=[];
    const clickHandler = view.on("click", async event=>{
      const groundPoint = await view.map.ground.queryElevation(event.mapPoint);
      points.push([groundPoint.x, groundPoint.y, groundPoint.z]);
      if(points.length>1){
        const polyline = new Polyline({ paths:[points], spatialReference:view.spatialReference });
        view.graphics.removeAll();
        view.graphics.add(new Graphic({ geometry: polyline, symbol:{ type:"simple-line", color:[0,150,255], width:3 } }));
        elevationWidget.input = new Graphic({ geometry: polyline });
      }
    });

    const observer = new MutationObserver(()=>{
      if(!document.getElementById("elevationPanel").classList.contains("open")){
        clickHandler.remove(); observer.disconnect();
      }
    });
    observer.observe(document.getElementById("elevationPanel"), { attributes:true, attributeFilter:["class"] });
  }

});
</script>
</body>
</html>
